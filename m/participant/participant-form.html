<div id=D__ID>
	<div class="container mt-95 mb-3">
		<div class="row">
			<!-- form container start -->
			<div class="col-12 col-lg-12 col-md-12 col-sm-12 mx-auto formbox">
				<div class="row">
					<div class="col-12">
						<!-- form start -->
						<form id=F__ID>
							<h3>Participant's Details</h3>
							<div class='row px-4'>
								<div class="col-sm-12 col-lg-4 row_participant__ID">
									<label class=''><span class=''>Participant ID</span>
										<input type=text class=form-control id=record__ID readonly>
									</label>
								</div>
								<div class="col-sm-12 col-lg-4">
									<label class=''><span class=''>Site</span>
										<select class=form-control name=Site id=site__ID required>
                                        </select>
									</label>
								</div>
								<div class="col-sm-12 col-lg-4">
									<label class=''><span class=''>Code</span>
										<input type=text class=form-control name=Code readonly>
									</label>
								</div>
							</div>
							<div class='row px-4'>
								<div class="col-sm-12 col-lg-4 ">
									<label class=''><span class=''>Gender</span>
										<select class=form-control name=Gender>
											<option value=''>---</option>
											<option>Male</option>
											<option>Female</option>
											<option>Other</option>
										</select>
									</label>
								</div>
                                <div class="col-sm-12 col-lg-4">
                                    <label class=''><span class=''>Subject Initials</span>
                                        <input type=text class=form-control name=Subject_Initials>
                                    </label>
                                </div>
								<div class="col-sm-12 col-lg-4">
									<label class=''><span class=''>DOB</span>
										<input type=date class=form-control name=DOB>
									</label>
								</div>
                            </div>
                            <div class='row px-4'>
                                <div class="col-sm-12 col-lg-4">
                                    <label class=''><span class=''>Pre-Screening Number (P)</span>
                                        <input type=text class=form-control name=Pre_Screening_Number readonly >
                                    </label>
                                </div>
                                <div class="col-sm-12 col-lg-4 row_screening__ID">
                                    <label class=''><span class=''>Screening Number (S)</span>
                                        <input type=text class=form-control name=Screening_Number readonly placeholder='click to get screening #'>
                                    </label>
                                </div>
								<div class="col-sm-12 col-lg-4 row_participant__ID">
									<label class=''><span class=''>Randomisation Number (R)</span>
										<input type=text class=form-control name=Randomisation_Number readonly placeholder='click to randomise'>
									</label>
								</div>
                            </div>
							<div class='row px-4'>
								<div class="col-sm-12 col-lg-4 row_participant__ID">
									<label class=''><span class=''>Randomised by</span>
										<input type=text class=form-control name=Randomised_by readonly>
									</label>
								</div>
                                <div class="col-sm-12 col-lg-4 ">
									<label class=''><span class=''>Password</span>
										<input type=text class=form-control name=_Password>
									</label>
								</div>
                                <div class="col-sm-12 col-lg-4 ">
									<label class=''><span class=''>Progress - Enable Visit</span>
										<select class=form-control name=_Progress>
                                            <option value="">Pre Screening</option>
                                            <option value="1">Screening</option>
                                            <option value="2">Baseline</option>
                                            <option value="3">6 Month</option>
                                            <option value="4">24 Month</option>
                                        </select>
									</label>
								</div>
							</div>
							<button type="submit" id="submit__ID" class="btn btn-primary btn-lg">Submit</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
	<script>
		function F__ID() {
			//-------------------------------------
			VmInclude: __COMPONENT__/f/form.01.js
			//-------------------------------------
            var load = m.load;
			m.load = function () {
				load();
				if (m.input.record == undefined) {
					$('.row_participant__ID').hide();
					$('#F__ID input[name=_Password').val($vm.vm_password(8, false)); 
					$('.row_screening__ID').hide();
				}
				else {
                    $('.row_screening__ID').show();
                    if(m.input.record.Data.Screening_Number== ""){
                        $('.row_participant__ID').hide()
                    }
                    else{
                        $('.row_participant__ID').show();
                    }
                    $('#record__ID').val(m.input.record.UID)

				}
                //--------------------------------
                var site_list;
                var query='[{"Data.Site":""}]';
                //console.log("User: "+$vm.user_name);
                //console.log(JSON.stringify(m.Table2))
                var query_user={"Data.user_name":$vm.user_name}
                jQuery.ajaxSetup({async:false});
                $vm.request({cmd:"find",table:m.Table2,query:query_user,limit:1},function(res){
                    if(res.status=='np' || res.result==undefined){
                        res.result=[];
                    }
                    else{
                        if(res.result[0]!=undefined){
                            if(res.result[0].Data.site!=undefined){
                                site_list=res.result[0].Data.site.split(',');
                            }    
                        }
                    }
                    if(res.status=='np'){
                        if(res.sys.tb=='on') $vm.alert("No permission. Private database table, ask the table's owner for permissions.");
                        else $vm.alert("No permission.");
                    }
                })
                jQuery.ajaxSetup({async:true});
                //console.log(site_list)
                dropdown="";
                for( var i=0;i<site_list.length;i++){
                    if(site_list[i]!=''){
                        dropdown+="<option value="+site_list[i]+">"+site_list[i]+"</option>"
                    }
                }
                //console.log(dropdown)
                $('#site__ID').html(dropdown);
                if (m.input.record == undefined) {
                    $('#site__ID').trigger("change");
                }
                else{
                    $('#site__ID').val(m.input.record.Data.Site);
                }
                //----------------------------
            }
            //-------------------------------
            $('#site__ID').change(function(){
                var query_user={"Data.Site":this.value}
                jQuery.ajaxSetup({async:false});
                $vm.request({cmd:"find",table:m.Table3,query:query_user,limit:1},function(res){

                    if(res.status=='np' || res.result==undefined){
                        res.result=[];
                    }
                    else{
                        if(res.result[0]!=undefined){
                            if(res.result[0].Data.Code!=undefined){
                                $('#F__ID input[name=Code').val(res.result[0].Data.Code)
                            }    
                        }
                    }
                    if(res.status=='np'){
                        if(res.sys.tb=='on') $vm.alert("No permission. Private database table, ask the table's owner for permissions.");
                        else $vm.alert("No permission.");
                    }
                })
                jQuery.ajaxSetup({async:true});
            })
			//-------------------------------------
			$('#F__ID input[name=Randomisation_Number]').on('click', function () {
				var I1 = $('#F__ID input[name=Randomisation_Number').val();
				if (I1 == '') {
                    var query={"Data.Code":$('#F__ID input[name=Code]').val()};
					$vm.request({ cmd: "find", table: m.Table, query:query, sort: { I1: -1 }, skip: 0, limit: 1 }, function (res) {
						if (res.sys.permission == false) {
							$vm.alert("No permission. Private database table, ask the table's owner for permissions.");
							return;
						}
						var max_I1 = 0;
                        console.log(JSON.stringify(res.result))
						if (res.result.length > 0) {
							if (res.result[0].I1 !== undefined) max_I1 = res.result[0].I1
						}
						max_I1++;
                        var code=$('#F__ID input[name=Code').val()
                        if(code=='NS') code='US'
						$('#F__ID input[name=Randomisation_Number').val('R'+code+max_I1.toString().padStart(3, "0"));
						$('#F__ID input[name=Randomised_by').val($vm.user_name);
					})
				}
			})
			//-------------------------------------
			$('#F__ID input[name=Screening_Number]').on('click', function () {
                var code=$('#F__ID input[name=Code').val()
                if(code=='NS') code='US'
				var I5 = $('#F__ID input[name=Screening_Number').val();
				if (I5 == '') {
					$vm.request({ cmd: "find", table: m.Table, sort: { I5: -1 }, skip: 0, limit: 1 }, function (res) {
						if (res.sys.permission == false) {
							$vm.alert("No permission. Private database table, ask the table's owner for permissions.");
							return;
						}
						var max_I5 = 0;
						if (res.result.length > 0) {
							if (res.result[0].I5 !== undefined) max_I5 = res.result[0].I5
						}
						max_I5++;
						$('#F__ID input[name=Screening_Number').val('S'+code+max_I5.toString().padStart(3, "0"));
					})
				}
			})
 			//-------------------------------------
             function calculateAge(birthday) { // birthday is a date
                var ageDifMs = Date.now() - birthday.getTime();
                var ageDate = new Date(ageDifMs); // miliseconds from epoch
                return Math.abs(ageDate.getUTCFullYear() - 1970);
            }
 			//-------------------------------------
			m.before_submit = function (data, index) {
                var dob=new Date($('#F__ID input[name=DOB]').val())
                var age=calculateAge(dob)
                if(age>75){
                    $vm.alert("This person is over 75 yrs")
                    return false;
                } 
                else if (age<50){
                    $vm.alert("This person is under 50 yrs")
                    return false;
                }
                else{
                    var I1 = $('#F__ID input[name=Randomisation_Number').val().slice(-3); if (I1 != '' && I1 != '-') index.I1 = parseInt(I1);
                    var I5 = $('#F__ID input[name=Screening_Number').val().slice(-3); if (I5 != '' && I5 != '-') index.I5 = parseInt(I5);
                    var nd=new Date()
                    index.I2=nd.getFullYear()+"-"+$vm.pad(nd.getMonth()+1,2)+"-"+$vm.pad(nd.getDate(),2);
                return;
                }
			}
			//-------------------------------------
            m.after_insert = function (data,res) {
                var rid=res.result.ops[0]._id
                if(data.Pre_Screening_Number==''){
                    var uid=res.result.ops[0].UID;
                    data.Pre_Screening_Number= 'P'+data.Code+uid.toString().padStart(3, "0")
                    $vm.request({cmd:'update',id:rid,table:m.Table,data:data},function(res){
                        //-----------------------------
                        if(res.status=="lk"){
                            $vm.alert("This record is locked.");
                            return;
                        }
                        //-----------------------------
                        if(res.status=="np"){
                            alert("No permission to update this record.");
                            return;
                        }
                    });
                }
                window.history.go(-1);
            }
			//-------------------------------------
/*            var autocomplete_req_1={cmd:"find",table:"demo-site-reshaped",options:{},skip:0,limit:10}
            var autocomplete_callback_1=function(items){ console.log(JSON.stringify(items));$("#F__ID input[name=Site]").val(items["Site"]);$("#F__ID input[name=Code]").val(items["code"]); }
            var autocomplete_list_1=function(records){
                var items=[];
                for(var i=0;i<records.length;i++){
                    var obj={};
                    obj.label=records[i].Data.Site;
                    obj.code=records[i].Data.Code;
                    obj['UID']=records[i].UID;
                    items.push(obj);
                }
                return items;
            }
            var wait1=function(){
                $vm.autocomplete($('#site__ID'),autocomplete_req_1,autocomplete_list_1,autocomplete_callback_1);
            }
            var I=0; var loop_1=setInterval(function (){
                if($vm['jquery-ui-min-js']!=undefined){  clearInterval(loop_1); wait1(); }
                I++; if(I>50){ clearInterval(loop_1); alert("jquery-ui.min.js is not installed."); }
            },100);
*/            //-------------------------------------
			$('#F__ID select[name=Site]').on('click', function () {
			})
			//-------------------------------------


		}
	</script>
	<style>
		#D__ID .mt-95 {
			max-width: 800px;
		}

		VmInclude:__CURRENT_PATH__/../../library/wappsystem-form.css
	</style>
</div>